"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[5655],{384(e,a,n){n.r(a),n.d(a,{assets:()=>i,contentTitle:()=>l,default:()=>p,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"manual-do-devops/infra/kubernetes-containers/61","title":"Integrando Vault com Kubernetes","description":"ATEN\xc7\xc3O, ESTE FLUXO \xc9 EXCLUSIVAMENTE PARA REALIZAR A INTEGRA\xc7\xc3O MANUALMENTE.","source":"@site/docs/03-manual-do-devops/infra/kubernetes-containers/integrando-vault-com-kubernetes.md","sourceDirName":"03-manual-do-devops/infra/kubernetes-containers","slug":"/manual-do-devops/infra/kubernetes-containers/61","permalink":"/docs-preview/docs/manual-do-devops/infra/kubernetes-containers/61","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/03-manual-do-devops/infra/kubernetes-containers/integrando-vault-com-kubernetes.md","tags":[],"version":"current","frontMatter":{"id":"61","title":"Integrando Vault com Kubernetes","updated_at":"2025-10-06T21:33:48.000Z"},"sidebar":"tutorialSidebar","previous":{"title":"Integra\xe7\xe3o do Kubernetes com Vault via External Secrets Operator","permalink":"/docs-preview/docs/manual-do-devops/infra/kubernetes-containers/56"},"next":{"title":"Integra\xe7\xe3o do Kubernetes com Vault via External Secrets Operator","permalink":"/docs-preview/docs/manual-do-devops/infra/kubernetes-vault/56"}}');var r=n(4848),o=n(8453);const s={id:61,title:"Integrando Vault com Kubernetes",updated_at:new Date("2025-10-06T21:33:48.000Z")},l="Integrando Vault com Kubernetes",i={},c=[{value:"<strong>ATEN\xc7\xc3O, ESTE FLUXO \xc9 EXCLUSIVAMENTE PARA REALIZAR A INTEGRA\xc7\xc3O MANUALMENTE.</strong>",id:"aten\xe7\xe3o-este-fluxo-\xe9-exclusivamente-para-realizar-a-integra\xe7\xe3o-manualmente",level:5},{value:"<strong>UTILIZE PREFERENCIALMENTE O BOT DO DISCORD PARA CRIAR OS PROJETOS E INTEGRAR O VAULT AUTOMATICAMENTE. ESTE FLUXO \xc9 APENAS UM \xdaLTIMA INST\xc2NCIA!</strong>",id:"utilize-preferencialmente-o-bot-do-discord-para-criar-os-projetos-e-integrar-o-vault-automaticamente-este-fluxo-\xe9-apenas-um-\xfaltima-inst\xe2ncia",level:5}];function d(e){const a={code:"code",h1:"h1",h5:"h5",header:"header",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a.header,{children:(0,r.jsx)(a.h1,{id:"integrando-vault-com-kubernetes",children:"Integrando Vault com Kubernetes"})}),"\n",(0,r.jsx)(a.h5,{id:"aten\xe7\xe3o-este-fluxo-\xe9-exclusivamente-para-realizar-a-integra\xe7\xe3o-manualmente",children:(0,r.jsx)(a.strong,{children:"ATEN\xc7\xc3O, ESTE FLUXO \xc9 EXCLUSIVAMENTE PARA REALIZAR A INTEGRA\xc7\xc3O MANUALMENTE."})}),"\n",(0,r.jsx)(a.h5,{id:"utilize-preferencialmente-o-bot-do-discord-para-criar-os-projetos-e-integrar-o-vault-automaticamente-este-fluxo-\xe9-apenas-um-\xfaltima-inst\xe2ncia",children:(0,r.jsx)(a.strong,{children:"UTILIZE PREFERENCIALMENTE O BOT DO DISCORD PARA CRIAR OS PROJETOS E INTEGRAR O VAULT AUTOMATICAMENTE. ESTE FLUXO \xc9 APENAS UM \xdaLTIMA INST\xc2NCIA!"})}),"\n",(0,r.jsx)(a.p,{children:"No terminal do droplet do Vault voc\xea precisar\xe1 rodar inicialmente o seguinte comando:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"export VAULT_ADDR=https://hashicorp-vault.digitalsys.app \n"})}),"\n",(0,r.jsx)(a.p,{children:"Com isso voc\xea conseguir\xe1 utilizar os comandos do Vault utilizado pela empresa"}),"\n",(0,r.jsx)(a.p,{children:"Dito isso, as etapas s\xe3o:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 1. Habilitar AppRole\n  vault auth enable approle\n\n"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:'## 2. Criar um arquivo de policy com a nomenclatura "nome-da-policy.hcl" e estutura abaixo\n  path "kv/data/apps/&lt;ambiente>//*" {\n    capabilities = ["read", "list"]\n  }\n  path "kv/metadata/apps/&lt;ambiente>//*" {\n    capabilities = ["list"]\n  }\n'})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 3. Aplicar a policy\n  vault policy write &lt;nome-da-policy> &lt;nome-da-policy>.hcl\n"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:'## 4. Criar role\n  vault write auth/approle/role/&lt;nome-da-role> \\\n    token_policies="&lt;nome-da-policy>" \\\n    token_ttl=1h \\\n    token_max_ttl=4h\n'})}),"\n",(0,r.jsx)(a.p,{children:"Obs.: note que <nome-da-policy> foi definido na etapa 3"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 5. Obtenha o valor de Role ID e Secret ID para utilizar no passo 6\n  vault read auth/approle/role/&lt;nome-da-role>/role-id           ## OBT\xc9M O ROLE ID\n  vault write -f auth/approle/role/&lt;nome-da-role>/secret-id.    ## OBT\xc9M O SECRET ID\n\n"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 6. Criar o secret no namespace. O exemplo abaixo foi gerado via kubectl, por\xe9m pode ser feito com outra ferramenta que te permita criar um secret\n\nkubectl create secret generic &lt;nome-do-secret> \\\n  -n &lt;namespace> \\\n  --from-literal=roleId=&lt;ROLE_ID> \\\n  --from-literal=secretId=&lt;SECRET_ID>\n"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 7. Crie um arquivo de SecretStore (&lt;nome-do-arquivo>.yml), com a estrutura abaixo\napiVersion: external-secrets.io/v1\nkind: ClusterSecretStore\nmetadata:\n  name: &lt;nome da store>\nspec:\n  provider:\n    vault:\n      server: &lt;URL do vault>\n      path: kv\n      version: v2\n      auth:\n        appRole:\n          path: approle\n          roleRef:\n            name: &lt;nome-do-secret>\n            key: roleId\n          secretRef:\n            name: &lt;nome-do-secret>\n            key: secretId\n"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 8. Aplique esse SecretStore no seu cluster\nkubectl apply -f &lt;nome-do-arquivo>.yaml\n"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 9. Crie o arquivo de ExternalSecret (&lt;nome-do-arquivo>.yml)\napiVersion: external-secrets.io/v1\nkind: ExternalSecret\nmetadata:\n  name: esus-api-secret\n  namespace: &lt;namespace a aplicar>\nspec:\n  secretStoreRef:\n    name: &lt;nome da store>  # \ud83d\udc48 exatamente o nome SecretStore, da etapa 7\n    kind: SecretStore\n  target:\n    name: &lt;nome da secret que ser\xe1 criado p/ salvar as informacoes>\n    creationPolicy: Owner\n  dataFrom:\n    - extract:\n        key: kv/data/apps/dev/esus/api #apenas um exemplo, aqui \xe9 o caminho que voc\xea criou no frontend do Vault\n"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"## 10. Aplique o arquivo de ExternalSecret\nkubectl apply -f &lt;nome do arquivo>\n"})}),"\n",(0,r.jsx)(a.p,{children:"Agora \xe9 poss\xedvel utilizar o secret no deploy do kubernetes, conforme exemplo abaixo:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n\xa0 name: {{ .Values.esusWeb.appName }}\n\xa0 namespace: {{ .Values.namespace }}\n\xa0 labels:\n\xa0 \xa0 app: {{ .Values.esusWeb.appName }}\nspec:\n\xa0 replicas: 1\n\xa0 selector:\n\xa0 \xa0 matchLabels:\n\xa0 \xa0 \xa0 app: {{ .Values.esusWeb.appName }}\n\xa0 template:\n\xa0 \xa0 metadata:\n\xa0 \xa0 \xa0 labels:\n\xa0 \xa0 \xa0 \xa0 app: {{ .Values.esusWeb.appName }}\n\xa0 \xa0 spec:\n\xa0 \xa0 \xa0 containers:\n\xa0 \xa0 \xa0 \xa0 - name: {{ .Values.esusWeb.appName }}\n\xa0 \xa0 \xa0 \xa0 \xa0 image: {{ .Values.esusWeb.image }}\n\xa0 \xa0 \xa0 \xa0 \xa0 ports:\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 - containerPort: {{ .Values.esusWeb.ports | first }}\n\xa0 \xa0 \xa0 \xa0 \xa0 envFrom:\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 - secretRef:\n\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 name: esus-web-env # <--- aqui vai o nome do secret , o mesmo que foi criado em target.name no item 7\n"})}),"\n",(0,r.jsx)(a.p,{children:"Obs.: Caso d\xea erro ao dar apply no ExternalSecret, usar os comandos abaixo para habilitar o External Secret:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:"##### **\ud83d\udd27 1. Adicionar o reposit\xf3rio Helm:**\nhelm repo add external-secrets https://charts.external-secrets.io\nhelm repo update\n\n##### **\ud83d\udd27 2. Instalar o ESO no cluster:**\nhelm upgrade --install external-secrets external-secrets/external-secrets \\\n  -n external-secrets \\\n  --create-namespace\n"})})]})}function p(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,r.jsx)(a,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,a,n){n.d(a,{R:()=>s,x:()=>l});var t=n(6540);const r={},o=t.createContext(r);function s(e){const a=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function l(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(o.Provider,{value:a},e.children)}}}]);