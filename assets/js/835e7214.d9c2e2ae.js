"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[9950],{3903(e,o,a){a.r(o),a.d(o,{assets:()=>l,contentTitle:()=>d,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"manual-do-dev/projetos/dip/callback","title":"CallBack","description":"1. Objetivo do Callback na Porto Seguro","source":"@site/docs/02-manual-do-dev/projetos/dip/callback.md","sourceDirName":"02-manual-do-dev/projetos/dip","slug":"/manual-do-dev/projetos/dip/callback","permalink":"/docs-preview/docs/manual-do-dev/projetos/dip/callback","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/02-manual-do-dev/projetos/dip/callback.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Vis\xe3o Geral T\xe9cnica (README)","permalink":"/docs-preview/docs/manual-do-dev/projetos/closecast-visao/visao-geral-tecnica-readme"},"next":{"title":"DIP - Gera\xe7\xe3o e Comissionamento de propostas","permalink":"/docs-preview/docs/manual-do-dev/projetos/dip/dip-geracao-e-comissionamento-de-propostas"}}');var n=a(4848),r=a(8453);const i={},d="CallBack",l={},c=[{value:"1. Objetivo do Callback na Porto Seguro",id:"1-objetivo-do-callback-na-porto-seguro",level:2},{value:"2. Passos Necess\xe1rios Lado Porto Seguro(Futuramente)",id:"2-passos-necess\xe1rios-lado-porto-segurofuturamente",level:2},{value:"Fluxo proposto:",id:"fluxo-proposto",level:5},{value:"3. Arquitetura da Funcionalidade Implementada (Nosso Sistema)",id:"3-arquitetura-da-funcionalidade-implementada-nosso-sistema",level:4},{value:"1 - Fluxo Resumido",id:"1---fluxo-resumido",level:5},{value:"2 - Handler",id:"2---handler",level:5},{value:"3 - Parsers",id:"3---parsers",level:5},{value:"4 - Facade",id:"4---facade",level:5}];function t(e){const o={a:"a",code:"code",h1:"h1",h2:"h2",h4:"h4",h5:"h5",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(o.header,{children:(0,n.jsx)(o.h1,{id:"callback",children:"CallBack"})}),"\n",(0,n.jsx)(o.h2,{id:"1-objetivo-do-callback-na-porto-seguro",children:"1. Objetivo do Callback na Porto Seguro"}),"\n",(0,n.jsx)(o.p,{children:"No fluxo de contrata\xe7\xe3o do Seguro Aluguel Fian\xe7a da Porto. Ap\xf3s o nosso sistema iniciar uma proposta, a Porto Seguro precisa de um meio para nos notificar sobre o resultado (aprovado, pendente ou recusado)."}),"\n",(0,n.jsx)(o.p,{children:"O objetivo do callback (webhook) \xe9 exatamente este: fornecer um mecanismo para que a Porto Seguro envie uma notifica\xe7\xe3o autom\xe1tica (um evento) para o nosso sistema assim que o processo de an\xe1lise for conclu\xeddo. Isso permite que nosso sistema d\xea continuidade ao fluxo de emiss\xe3o da proposta de forma automatizada, sem a necessidade de consultas manuais ."}),"\n",(0,n.jsx)(o.h2,{id:"2-passos-necess\xe1rios-lado-porto-segurofuturamente",children:"2. Passos Necess\xe1rios Lado Porto Seguro(Futuramente)"}),"\n",(0,n.jsxs)(o.p,{children:["Para que a Porto Seguro possa nos enviar notifica\xe7\xf5es, \xe9 preciso registrar nosso endpoint de callback em seu sistema. Isso \xe9 feito atrav\xe9s da ",(0,n.jsx)(o.strong,{children:"API de Cadastro do Webhook"})," deles."]}),"\n",(0,n.jsxs)(o.ol,{children:["\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.strong,{children:"Obter Credenciais"}),": \xc9 necess\xe1rio ter um ",(0,n.jsx)(o.code,{children:"Client ID"})," e ",(0,n.jsx)(o.code,{children:"Client Secret"})," v\xe1lidos para o ambiente desejado (Homologa\xe7\xe3o ou Produ\xe7\xe3o), obtidos atrav\xe9s do Portal do Desenvolvedor da Porto."]}),"\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.strong,{children:"Registrar o Webhook"}),": Realizar uma chamada ",(0,n.jsx)(o.code,{children:"POST"})," para a API de Cadastro de Webhook da Porto:","\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.strong,{children:"Endpoint"}),": ",(0,n.jsx)(o.code,{children:"https://weebhook-parceiros.riscos-financeiros[AMBIENTE].com/envio/v1/inclusaoCadastro"})]}),"\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.strong,{children:"Payload"}),": No corpo da requisi\xe7\xe3o, devemos enviar um JSON contendo, entre outras coisas:","\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.code,{children:"nomeParceiro"}),": Um identificador para a nossa integra\xe7\xe3o (ex: ",(0,n.jsx)(o.code,{children:"Review.HML.INT"}),")."]}),"\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.code,{children:"clientId"}),": Nosso Client ID."]}),"\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.code,{children:"apiCallback"}),": Um objeto que descreve nosso endpoint. \xc9 aqui que informamos a URL do nosso sistema que receber\xe1 a notifica\xe7\xe3o.","\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsxs)(o.li,{children:[(0,n.jsx)(o.strong,{children:"URL"}),": ",(0,n.jsx)(o.code,{children:"https://[URL_DO_NOSSO_SISTEMA]/callback/{dsTenantId}/porto"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(o.p,{children:(0,n.jsx)(o.strong,{children:"Esse ponto n\xe3o precisamos nos preocupar por enquanto, s\xf3 com a parte de recebimento dos updates de proposta"})}),"\n",(0,n.jsx)(o.h5,{id:"fluxo-proposto",children:"Fluxo proposto:"}),"\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsxs)(o.li,{children:["\n",(0,n.jsxs)(o.p,{children:["Usu\xe1rio acessa a p\xe1gina de integra\xe7\xf5es (ex.: ",(0,n.jsx)(o.a,{href:"http://localhost:3000/admin/integracao",children:"http://localhost:3000/admin/integracao"}),")."]}),"\n"]}),"\n",(0,n.jsxs)(o.li,{children:["\n",(0,n.jsx)(o.p,{children:'Na tabela de integra\xe7\xf5es, cada item tem um bot\xe3o "Cadastrar Callback" e um campo booleano is_callback_active para indicar se o callback est\xe1 ativo.'}),"\n"]}),"\n",(0,n.jsxs)(o.li,{children:["\n",(0,n.jsx)(o.p,{children:"Ao clicar no bot\xe3o, o sistema chama uma fun\xe7\xe3o interna ex; RegisterCallback que:"}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(o.p,{children:"-Gera ou token Basic fixo(pedido no endpoint de cadastro da porto), armazenado na collection Token(ja existente) com tokenType registerCallback."}),"\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsxs)(o.li,{children:["\n",(0,n.jsx)(o.p,{children:"Monta o payload da requisi\xe7\xe3o com os detalhes dos nossos endpoints (auth e callback), incluindo o token Basic no campo tokenApi."}),"\n"]}),"\n",(0,n.jsxs)(o.li,{children:["\n",(0,n.jsxs)(o.p,{children:["Faz uma chamada POST para a API de Cadastro de Webhook da Porto (",(0,n.jsx)(o.a,{href:"https://weebhook-parceiros.riscos-financeiros%5C%5BAMBIENTE%5C%5D.com/envio/v1/inclusaoCadastro",children:"https://weebhook-parceiros.riscos-financeiros\\[AMBIENTE\\].com/envio/v1/inclusaoCadastro"}),")."]}),"\n"]}),"\n",(0,n.jsxs)(o.li,{children:["\n",(0,n.jsx)(o.p,{children:"Se a resposta for sucesso (status 200), atualiza o campo is_callback_active da integration para true no banco de dados."}),"\n"]}),"\n",(0,n.jsxs)(o.li,{children:["\n",(0,n.jsx)(o.p,{children:"O token Basic \xe9 usado pela Porto para autenticar chamadas ao nosso endpoint de auth (/callback/auth), que responde com um JWT v\xe1lido."}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(o.h4,{id:"3-arquitetura-da-funcionalidade-implementada-nosso-sistema",children:"3. Arquitetura da Funcionalidade Implementada (Nosso Sistema)"}),"\n",(0,n.jsx)(o.h5,{id:"1---fluxo-resumido",children:"1 - Fluxo Resumido"}),"\n",(0,n.jsxs)(o.ol,{children:["\n",(0,n.jsxs)(o.li,{children:["Seguradora \u2192 POST ",(0,n.jsx)(o.code,{children:"/callback/:dsTenantId/:insuranceCompany"})]}),"\n",(0,n.jsx)(o.li,{children:"Handler identifica seguradora, l\xea payload bruto."}),"\n",(0,n.jsx)(o.li,{children:"Seleciona o parser da seguradora."}),"\n",(0,n.jsxs)(o.li,{children:["Parser valida e traduz payload externo \u2192 ",(0,n.jsx)(o.a,{href:"about:blank",children:"model.Callback"}),"."]}),"\n",(0,n.jsxs)(o.li,{children:["Handler injeta ",(0,n.jsx)(o.a,{href:"about:blank",children:"DsTenantID"})," (da url) no objeto."]}),"\n",(0,n.jsxs)(o.li,{children:["Chama o metodo para processar o callback, criado em proposalFacade: ",(0,n.jsx)(o.code,{children:"ProcessProposalCallback()"}),"."]}),"\n",(0,n.jsxs)(o.li,{children:["Fa\xe7ade:","\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsx)(o.li,{children:"Valida integridade (tenant, proposta, estado)."}),"\n",(0,n.jsx)(o.li,{children:"Atualiza proposta / hist\xf3rico / eventos."}),"\n",(0,n.jsx)(o.li,{children:"Aplica regras (finaliza\xe7\xe3o, remo\xe7\xe3o de fila, notifica\xe7\xf5es)."}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(o.li,{children:"Resposta HTTP 200 em caso de sucesso (ou c\xf3digo de erro contextualizado)"}),"\n"]}),"\n",(0,n.jsx)(o.h5,{id:"2---handler",children:"2 - Handler"}),"\n",(0,n.jsxs)(o.ol,{children:["\n",(0,n.jsx)(o.li,{children:"Validar par\xe2metros da requisi\xe7\xe3o."}),"\n",(0,n.jsx)(o.li,{children:"Ler payload."}),"\n",(0,n.jsx)(o.li,{children:"Resolver parser pelo identificador da seguradora com um if(ou switch para ficar menos verboso)."}),"\n",(0,n.jsx)(o.li,{children:"Executar Parse()."}),"\n",(0,n.jsx)(o.li,{children:"Popular DsTenantID no objeto."}),"\n",(0,n.jsx)(o.li,{children:"Encaminhar para a facade, proposalFacade -> ProcessProposalCallback()"}),"\n",(0,n.jsx)(o.li,{children:"Tratar e converter erros em seus status HTTP."}),"\n"]}),"\n",(0,n.jsx)(o.h5,{id:"3---parsers",children:"3 - Parsers"}),"\n",(0,n.jsx)(o.p,{children:"V\xe3o ser criados em rest/handlers/callback/parsers  separando em arquivos diferentes para cada seguradora."}),"\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsx)(o.li,{children:(0,n.jsx)(o.code,{children:"porto_parser.go"})}),"\n",(0,n.jsx)(o.li,{children:(0,n.jsx)(o.code,{children:"tokio_parser.go"})}),"\n",(0,n.jsx)(o.li,{children:(0,n.jsx)(o.code,{children:"too_parser.go"})}),"\n"]}),"\n",(0,n.jsxs)(o.ol,{children:["\n",(0,n.jsx)(o.li,{children:"Recebe o payload da seguradora"}),"\n",(0,n.jsx)(o.li,{children:"Instancia o objeto de /model/callback.go"}),"\n",(0,n.jsx)(o.li,{children:"Mapping dos status possiveis que a seguradora pode enviar, apontando para os nossos."}),"\n",(0,n.jsx)(o.li,{children:"Fun\xe7\xe3o Parse(), que traduz os campos do payload, preenchendo os campos do nosso objeto."}),"\n",(0,n.jsx)(o.li,{children:"Retorna para o handler."}),"\n"]}),"\n",(0,n.jsx)(o.h5,{id:"4---facade",children:"4 - Facade"}),"\n",(0,n.jsxs)(o.ol,{children:["\n",(0,n.jsx)(o.li,{children:"Metodo em proposalFacade, que recebe nosso objeto interno preenchido."}),"\n",(0,n.jsx)(o.li,{children:"Valida alguns campos essenciais"}),"\n",(0,n.jsx)(o.li,{children:"Localiza a proposta, utilizando dsTenantId como indice + o proposalID"}),"\n",(0,n.jsx)(o.li,{children:"Valida as transi\xe7\xf5es de status. compara o antigo com o atual"}),"\n",(0,n.jsx)(o.li,{children:"Atualiza a proposta"}),"\n",(0,n.jsx)(o.li,{children:"Atualiza o historico de integra\xe7\xe3o"}),"\n",(0,n.jsx)(o.li,{children:"Verifica se deve ser removida da fila"}),"\n",(0,n.jsx)(o.li,{children:"Dispara email"}),"\n"]})]})}function u(e={}){const{wrapper:o}={...(0,r.R)(),...e.components};return o?(0,n.jsx)(o,{...e,children:(0,n.jsx)(t,{...e})}):t(e)}},8453(e,o,a){a.d(o,{R:()=>i,x:()=>d});var s=a(6540);const n={},r=s.createContext(n);function i(e){const o=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function d(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),s.createElement(r.Provider,{value:o},e.children)}}}]);