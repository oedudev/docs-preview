"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[8354],{599(e,a,n){n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"manual-do-devops/infra/kubernetes-containers/56","title":"Integra\xe7\xe3o do Kubernetes com Vault via External Secrets Operator","description":"Objetivo","source":"@site/docs/03-manual-do-devops/infra/kubernetes-containers/integracao-do-kubernetes-com-vault-via-external-secrets-operator.md","sourceDirName":"03-manual-do-devops/infra/kubernetes-containers","slug":"/manual-do-devops/infra/kubernetes-containers/56","permalink":"/docs-preview/docs/manual-do-devops/infra/kubernetes-containers/56","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/03-manual-do-devops/infra/kubernetes-containers/integracao-do-kubernetes-com-vault-via-external-secrets-operator.md","tags":[],"version":"current","frontMatter":{"id":"56","title":"Integra\xe7\xe3o do Kubernetes com Vault via External Secrets Operator","updated_at":"2025-04-27T00:06:29.000Z"},"sidebar":"tutorialSidebar","previous":{"title":"Configura\xe7\xe3o de novos clusters","permalink":"/docs-preview/docs/manual-do-devops/infra/kubernetes-containers/148"},"next":{"title":"Integrando Vault com Kubernetes","permalink":"/docs-preview/docs/manual-do-devops/infra/kubernetes-containers/61"}}');var t=n(4848),o=n(8453);const s={id:56,title:"Integra\xe7\xe3o do Kubernetes com Vault via External Secrets Operator",updated_at:new Date("2025-04-27T00:06:29.000Z")},i="Integra\xe7\xe3o do Kubernetes com Vault via External Secrets Operator",c={},l=[{value:"Objetivo",id:"objetivo",level:2},{value:"1. Instala\xe7\xe3o dos componentes necess\xe1rios",id:"1-instala\xe7\xe3o-dos-componentes-necess\xe1rios",level:2},{value:"External Secrets Operator (ESO)",id:"external-secrets-operator-eso",level:3},{value:"Stakater Reloader",id:"stakater-reloader",level:3},{value:"2. Configura\xe7\xe3o do Vault",id:"2-configura\xe7\xe3o-do-vault",level:2},{value:"Criar policy para acesso aos secrets",id:"criar-policy-para-acesso-aos-secrets",level:3},{value:"Criar token renov\xe1vel no Vault",id:"criar-token-renov\xe1vel-no-vault",level:3},{value:"Verificar token",id:"verificar-token",level:3},{value:"3. Configura\xe7\xe3o no Kubernetes",id:"3-configura\xe7\xe3o-no-kubernetes",level:2},{value:"Criar Secret com o token do Vault",id:"criar-secret-com-o-token-do-vault",level:3},{value:"Criar ClusterSecretStore apontando para o Vault",id:"criar-clustersecretstore-apontando-para-o-vault",level:3},{value:"Criar ExternalSecret em cada namespace de aplica\xe7\xe3o",id:"criar-externalsecret-em-cada-namespace-de-aplica\xe7\xe3o",level:3},{value:"Adicionar anotacao de reload no Deployment",id:"adicionar-anotacao-de-reload-no-deployment",level:3},{value:"4. Fluxo de atualiza\xe7\xe3o",id:"4-fluxo-de-atualiza\xe7\xe3o",level:2},{value:"5. Considera\xe7\xf5es futuras",id:"5-considera\xe7\xf5es-futuras",level:2}];function d(e){const a={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.header,{children:(0,t.jsx)(a.h1,{id:"integra\xe7\xe3o-do-kubernetes-com-vault-via-external-secrets-operator",children:"Integra\xe7\xe3o do Kubernetes com Vault via External Secrets Operator"})}),"\n",(0,t.jsx)(a.h2,{id:"objetivo",children:"Objetivo"}),"\n",(0,t.jsxs)(a.p,{children:["Este guia descreve o processo de integra\xe7\xe3o do Kubernetes com o HashiCorp Vault para gerenciar secrets de forma segura e automatizada, usando o ",(0,t.jsx)(a.strong,{children:"External Secrets Operator (ESO)"})," e o ",(0,t.jsx)(a.strong,{children:"Stakater Reloader"})," para reiniciar pods automaticamente quando secrets mudarem."]}),"\n",(0,t.jsx)(a.hr,{}),"\n",(0,t.jsx)(a.h2,{id:"1-instala\xe7\xe3o-dos-componentes-necess\xe1rios",children:"1. Instala\xe7\xe3o dos componentes necess\xe1rios"}),"\n",(0,t.jsx)(a.h3,{id:"external-secrets-operator-eso",children:"External Secrets Operator (ESO)"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"helm repo add external-secrets https://charts.external-secrets.io\nhelm repo update\nhelm install external-secrets external-secrets/external-secrets --namespace external-secrets --create-namespace\n"})}),"\n",(0,t.jsx)(a.h3,{id:"stakater-reloader",children:"Stakater Reloader"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"helm repo add stakater https://stakater.github.io/stakater-charts\nhelm repo update\nhelm install reloader stakater/reloader --namespace reloader --create-namespace\n"})}),"\n",(0,t.jsx)(a.hr,{}),"\n",(0,t.jsx)(a.h2,{id:"2-configura\xe7\xe3o-do-vault",children:"2. Configura\xe7\xe3o do Vault"}),"\n",(0,t.jsx)(a.h3,{id:"criar-policy-para-acesso-aos-secrets",children:"Criar policy para acesso aos secrets"}),"\n",(0,t.jsxs)(a.p,{children:["Arquivo ",(0,t.jsx)(a.code,{children:"external-secrets-access.hcl"}),":"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:'path "kv/data/dev/*" {\n  capabilities = ["read", "list"]\n}\n\npath "kv/metadata/dev/" {\n  capabilities = ["list"]\n}\n\npath "kv/metadata/dev/*" {\n  capabilities = ["list"]\n}\n'})}),"\n",(0,t.jsx)(a.p,{children:"Aplicar a policy:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"vault policy write external-secrets-access external-secrets-access.hcl\n"})}),"\n",(0,t.jsx)(a.h3,{id:"criar-token-renov\xe1vel-no-vault",children:"Criar token renov\xe1vel no Vault"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:'vault token create -policy="external-secrets-access" -period=24h\n'})}),"\n",(0,t.jsxs)(a.p,{children:[(0,t.jsx)(a.strong,{children:"Importante:"})," O token deve ter ",(0,t.jsx)(a.code,{children:"renewable: true"}),"."]}),"\n",(0,t.jsx)(a.h3,{id:"verificar-token",children:"Verificar token"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"vault token lookup s.XXXXXXXX\n"})}),"\n",(0,t.jsx)(a.hr,{}),"\n",(0,t.jsx)(a.h2,{id:"3-configura\xe7\xe3o-no-kubernetes",children:"3. Configura\xe7\xe3o no Kubernetes"}),"\n",(0,t.jsx)(a.h3,{id:"criar-secret-com-o-token-do-vault",children:"Criar Secret com o token do Vault"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"kubectl create secret generic vault-token \\\n  --from-literal=token='s.XXXXXXXX' \\\n  -n external-secrets\n"})}),"\n",(0,t.jsx)(a.h3,{id:"criar-clustersecretstore-apontando-para-o-vault",children:"Criar ClusterSecretStore apontando para o Vault"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:'apiVersion: external-secrets.io/v1beta1\nkind: ClusterSecretStore\nmetadata:\n  name: vault-backend\nspec:\n  provider:\n    vault:\n      server: "https://vault.seusite.com"\n      path: "kv"\n      version: "v2"\n      auth:\n        tokenSecretRef:\n          name: vault-token\n          key: token\n          namespace: external-secrets\n'})}),"\n",(0,t.jsxs)(a.p,{children:[(0,t.jsx)(a.strong,{children:"Observa\xe7\xe3o:"})," N\xe3o \xe9 necess\xe1rio configurar ",(0,t.jsx)(a.code,{children:"tokenRenewalDuration"}),". O ESO renova automaticamente se o token for renov\xe1vel."]}),"\n",(0,t.jsx)(a.h3,{id:"criar-externalsecret-em-cada-namespace-de-aplica\xe7\xe3o",children:"Criar ExternalSecret em cada namespace de aplica\xe7\xe3o"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:'apiVersion: external-secrets.io/v1beta1\nkind: ExternalSecret\nmetadata:\n  name: minha-api-secret\n  namespace: dev\nspec:\n  refreshInterval: "1m"\n  secretStoreRef:\n    name: vault-backend\n    kind: ClusterSecretStore\n  target:\n    name: minha-api-secret-k8s\n    creationPolicy: Owner\n  dataFrom:\n  - extract:\n      key: dev/apps/statis/api\n'})}),"\n",(0,t.jsx)(a.h3,{id:"adicionar-anotacao-de-reload-no-deployment",children:"Adicionar anotacao de reload no Deployment"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: meu-app\n  namespace: dev\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: meu-app\n  template:\n    metadata:\n      labels:\n        app: meu-app\n      annotations:\n        secret.reloader.stakater.com/reload: "minha-api-secret-k8s"\n    spec:\n      containers:\n      - name: meu-container\n        image: alpine:latest\n        command: ["/bin/sh", "-c"]\n        args:\n          - |\n            echo "Vari\xe1veis de Ambiente:" && env && echo "Aguardando 5 minutos..." && sleep 300\n        envFrom:\n        - secretRef:\n            name: minha-api-secret-k8s\n'})}),"\n",(0,t.jsx)(a.hr,{}),"\n",(0,t.jsx)(a.h2,{id:"4-fluxo-de-atualiza\xe7\xe3o",children:"4. Fluxo de atualiza\xe7\xe3o"}),"\n",(0,t.jsxs)(a.ol,{children:["\n",(0,t.jsx)(a.li,{children:"Altera\xe7\xf5es no Vault atualizam o Secret no Kubernetes automaticamente via ESO."}),"\n",(0,t.jsx)(a.li,{children:"O Stakater Reloader detecta a mudan\xe7a no Secret."}),"\n",(0,t.jsx)(a.li,{children:"O Deployment da aplica\xe7\xe3o \xe9 reiniciado automaticamente para carregar as novas vari\xe1veis de ambiente."}),"\n"]}),"\n",(0,t.jsx)(a.hr,{}),"\n",(0,t.jsx)(a.h2,{id:"5-considera\xe7\xf5es-futuras",children:"5. Considera\xe7\xf5es futuras"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsxs)(a.li,{children:[(0,t.jsx)(a.strong,{children:"Rotacionar tokens periodicamente"})," (boa pr\xe1tica de seguran\xe7a)."]}),"\n",(0,t.jsxs)(a.li,{children:[(0,t.jsx)(a.strong,{children:"Considerar uso de AppRole"})," para ambientes de produ\xe7\xe3o de alta seguran\xe7a."]}),"\n",(0,t.jsxs)(a.li,{children:[(0,t.jsx)(a.strong,{children:"Adicionar monitoramento"})," para verificar falhas de renova\xe7\xe3o do token ou falhas no ESO."]}),"\n"]}),"\n",(0,t.jsx)(a.hr,{}),"\n",(0,t.jsxs)(a.p,{children:[(0,t.jsx)(a.strong,{children:"Status atual:"})," Configura\xe7\xe3o segura, com atualiza\xe7\xe3o autom\xe1tica de secrets e renova\xe7\xe3o autom\xe1tica do token Vault."]})]})}function u(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,a,n){n.d(a,{R:()=>s,x:()=>i});var r=n(6540);const t={},o=r.createContext(t);function s(e){const a=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function i(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),r.createElement(o.Provider,{value:a},e.children)}}}]);